---
layout: post
image: https://img.peapix.com/2671600313738979838_320.jpg
author: missdeer
title: "讨教Plugins设计"
categories:
- Plugin Framework
---
<p>　　下午去向人讨教了一下人家怎么设计实现Plugins机制的。据该人士讲述，当时他们的产品2.x版本面对各种千奇百怪的用户需求，以及进度压力（这与我们目前遭遇到的情况类似），经过研究COM相关技术和Eclipse（估计当时也是2.x版本）的Plugins机制，最后在3.0版本实现了目前（也是3.x吧）的Plugins机制。<br />　　首先，该软件产品一般的插件都是通过vbs脚本实现，他们内嵌了vbs脚本解释器，使用的当然是最流行最正规的IActiveScript之道。可以扩展的地方包括主菜单、工具栏、弹出式菜单、状态栏等。像Eclipse及其他很多软件一样，基本的界面元素是用XML描述的，以弹出式菜单为例，在XML中首先会定义视图之类的信息，而弹出式菜单是作为视图信息的子节点出现的，说明这个弹出式菜单是在视图上点击右键才会弹出。这里好像是XML里就直接指定了菜单项的ID，对应Windows程序里的命令ID，而ID范围是程序中已固化规定好的，不能超出这个范围。然后指定一个脚本文件，可能还会具体到其中某个函数，每当菜单项触发时，便调用这段脚本。可能还会有触发前、触发后的选项，可以继续使用自定义脚本扩展实现。另外，菜单项有一个状态，如disabled、checked等等，这是在另外一个属性中设置的，该属性同样是指定一个脚本文件或函数，刚好对应MFC中的ON_UPDATE_COMMAND_UI。还有一点是，菜单可能是针对某种具体的选中项才有项的，所以在XML中描述菜单时，可能会包含一个属性，用于指定对其有效的选中项类型，只有在该类型的界面元素被选中并在上面点击鼠标右键时，才会弹出这个菜单。再有就是菜单等界面元素不可避免的一个问题是国际化，他们是把各种语言对应的字符串信息分别写到不同的配置文件中，描述菜单信息的XML里通过指定个别名或ID来动态查找装入相应的字符串。如果激活扩展插件函数时，需要一些固有信息，而是通过规定的格式书写函数参数。<br />　　其次，除了支持脚本扩展，该软件还支持COM组件形式的Plugins，这种Plugins相比脚本Plugins肯定强大得多，也许就好比Firefox中的Plugins之于Extensions，不过在介绍时他们一带而过，似乎也不是很支持第三方的去使用这种机制。<br />　　最后说一点，为了实现能让vbs脚本访问host程序中的一些信息或方法，他们把所有的东西都用COM接口还实现。似乎这是目前而言，我们能找到的最简单的一种处理方式，所有的状态、中间数据信息都可以保存在host程序中，脚本应该只是描述逻辑，而不保存状态。但这也是我最不屑的，我还是比较欣赏Eclipse（3.0以后用OSGi的不知道有多少变化）的机制，希望我有机会能设计并把它实现！</p>
