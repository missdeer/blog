---
layout: post
title: Ninayan W.I.P.(14)
categories:
- Ninayan
- SNS
tags:
- Ninayan
- Qt
- SNSmeta:
  _wp_old_slug: ''
---
<p>　　前面说到内存泄漏的问题。后来通过逐段屏蔽代码，终于找到了最大一处泄漏源。这个办法比较笨，但这次真的有用，主要还是因为程序结构简单，流程也不复杂才能用吧。<br />
　　程序大体上分为三部分，UI层，数据层，网络通信层。用户在UI层上操作，1、UI层向数据层请求数据，2、数据层根据不同情况直接查询本地数据库或通过网络通信层获取数据，3、网络通信层自己有一个定时轮循的任务，每分钟从远程服务器获取数据，4、有了数据就发送给数据层，5、数据层将数据经过简单处理发送给UI层，6、然后显示，就是这么简单。<br />
　　我开始主要怀疑UI显示调用的Qt/QML也许MM有问题，于是把最终UI显示的代码屏蔽掉。发现仍然泄漏的情况基本没有变化，说明跟UI显示的关系不大。后来发现Mem Usage的增长是有周期，大概是1分钟1次，那么可以确定是在4和5两步有问题。这时把第5步中代码全部屏蔽掉，果然Mem Usage就不增长了。然后逐步缩小范围，一点点放出代码，最后发现竟然是QSqlQuery查询本地数据库时，select出来的东西需要程序员自己clear掉！内牛满面啊，果然是Qt用得有问题！<br />
　　今天偶然发现一个叫MacType的东东，可以在Windows下以进程注入的方式给指定进程增强字体渲染效果。跟微软官方的ClearType Tuner是一类东西，不过MacType的选项更丰富。于是我想到，我这个以阅读为主的工具，要是集成这么个美仑美奂的功能，该是多酷啊。在极限论坛翻了一遍帖子，貌似MacType是闭源的，另外有个新生的Gdipp项目，倒是在googlecode上开源了，不过听说它的配置复杂，而且目前不够稳定，尤其是32位系统上。好吧，反正这种功能对我有致命吸引力，一定要集成！</p>
