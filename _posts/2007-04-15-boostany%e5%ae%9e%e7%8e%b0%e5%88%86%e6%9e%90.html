---
layout: post
image: https://img.peapix.com/18152564736724210959_320.jpg
author: missdeer
title: Boost::any实现分析
categories:
- CPPOOPGPXP
---
<p>　　在看《Conversations》的时候，看到有一章，专门讲到了Boost::any，不禁又勾起我对<a href="http://www.boost.org/">Boost</a>的敬佩之情。<br />　　打开any.hpp，看到any类的实现非常简单，2个构造函数，1个拷贝构造函数，2个赋值运算符重载，1 个指针类型的成员变量，以及几个辅助函数。可正是这样一个简单的类，实现了极为巧妙极其方便的功能。看看C++对COM中的Variant的封装，把各种 想得到的数据类型都嵌入到union中，同时需要一个附加字段来指定当前实际的数据类型，代码看起来不但臃肿冗余，而且也不好用。<br />　　来看看any的实现代码，首先它是被放在boost名字空间的，其次，any当然不是一个模板类，不然在对不同的数据类型实例化后，不能方便地以统一的类型表示了：
<pre><tt><tt>  <b><span style="color: rgb(0, 0, 255);">class</span></b> any<br /> <span style="color: rgb(255, 0, 0);">{</span><br /> <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> structors</span></i><br /><br />     <b><span style="color: rgb(0, 0, 0);">any</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span><br />       <span style="color: rgb(153, 0, 0);">:</span> <b><span style="color: rgb(0, 0, 0);">content</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 51, 153);">0</span><span style="color: rgb(153, 0, 0);">)</span><br />     <span style="color: rgb(255, 0, 0);">{</span><br />     <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">template</span></b><span style="color: rgb(153, 0, 0);"><</span><b><span style="color: rgb(0, 0, 255);">typename</span></b> ValueType<span style="color: rgb(153, 0, 0);">></span><br />     <b><span style="color: rgb(0, 0, 0);">any</span></b><span style="color: rgb(153, 0, 0);">(</span><b><span style="color: rgb(0, 0, 255);">const</span></b> ValueType <span style="color: rgb(153, 0, 0);">&</span> value<span style="color: rgb(153, 0, 0);">)</span><br />       <span style="color: rgb(153, 0, 0);">:</span> <b><span style="color: rgb(0, 0, 0);">content</span></b><span style="color: rgb(153, 0, 0);">(</span><b><span style="color: rgb(0, 0, 255);">new</span></b> holder<span style="color: rgb(153, 0, 0);"><</span>ValueType<span style="color: rgb(153, 0, 0);">></span><span style="color: rgb(153, 0, 0);">(</span>value<span style="color: rgb(153, 0, 0);">)</span><span style="color: rgb(153, 0, 0);">)</span><br />     <span style="color: rgb(255, 0, 0);">{</span><br />     <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <b><span style="color: rgb(0, 0, 0);">any</span></b><span style="color: rgb(153, 0, 0);">(</span><b><span style="color: rgb(0, 0, 255);">const</span></b> any <span style="color: rgb(153, 0, 0);">&</span> other<span style="color: rgb(153, 0, 0);">)</span><br />       <span style="color: rgb(153, 0, 0);">:</span> <b><span style="color: rgb(0, 0, 0);">content</span></b><span style="color: rgb(153, 0, 0);">(</span>other<span style="color: rgb(153, 0, 0);">.</span>content <span style="color: rgb(153, 0, 0);">?</span> other<span style="color: rgb(153, 0, 0);">.</span>content<span style="color: rgb(153, 0, 0);">-</span><span style="color: rgb(153, 0, 0);">></span><b><span style="color: rgb(0, 0, 0);">clone</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span> <span style="color: rgb(153, 0, 0);">:</span> <span style="color: rgb(153, 51, 153);">0</span><span style="color: rgb(153, 0, 0);">)</span><br />     <span style="color: rgb(255, 0, 0);">{</span><br />     <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <span style="color: rgb(153, 0, 0);">~</span><b><span style="color: rgb(0, 0, 0);">any</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span><br />     <span style="color: rgb(255, 0, 0);">{</span><br />         <b><span style="color: rgb(0, 0, 255);">delete</span></b> content<span style="color: rgb(153, 0, 0);">;</span><br />     <span style="color: rgb(255, 0, 0);">}</span></tt></tt><br /></pre>
<pre><tt><tt><tt><tt><i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> ……………………</span></i></tt></tt></tt></tt></pre>
<pre><tt><tt><b><span style="color: rgb(0, 0, 128);">#ifndef</span></b> BOOST_NO_MEMBER_TEMPLATE_FRIENDS<br /> <b><span style="color: rgb(0, 0, 255);">private</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> representation</span></i><br />     <b><span style="color: rgb(0, 0, 255);">template</span></b><span style="color: rgb(153, 0, 0);"><</span><b><span style="color: rgb(0, 0, 255);">typename</span></b> ValueType<span style="color: rgb(153, 0, 0);">></span><br />     <b><span style="color: rgb(0, 0, 255);">friend</span></b> ValueType <span style="color: rgb(153, 0, 0);">*</span> <b><span style="color: rgb(0, 0, 0);">any_cast</span></b><span style="color: rgb(153, 0, 0);">(</span>any <span style="color: rgb(153, 0, 0);">*</span><span style="color: rgb(153, 0, 0);">)</span><span style="color: rgb(153, 0, 0);">;</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">template</span></b><span style="color: rgb(153, 0, 0);"><</span><b><span style="color: rgb(0, 0, 255);">typename</span></b> ValueType<span style="color: rgb(153, 0, 0);">></span><br />     <b><span style="color: rgb(0, 0, 255);">friend</span></b> ValueType <span style="color: rgb(153, 0, 0);">*</span> <b><span style="color: rgb(0, 0, 0);">unsafe_any_cast</span></b><span style="color: rgb(153, 0, 0);">(</span>any <span style="color: rgb(153, 0, 0);">*</span><span style="color: rgb(153, 0, 0);">)</span><span style="color: rgb(153, 0, 0);">;</span><br /><b><span style="color: rgb(0, 0, 128);">#else</span></b><br /> <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> representation (public so any_cast can be non-friend)</span></i><br /><b><span style="color: rgb(0, 0, 128);">#endif</span></b><br />     placeholder <span style="color: rgb(153, 0, 0);">*</span> content<span style="color: rgb(153, 0, 0);">;</span><br /> <span style="color: rgb(255, 0, 0);">}</span><span style="color: rgb(153, 0, 0);">;</span></tt></tt></pre>
<p>　　这是它的构造函数、拷贝构造函数和析构函数，content是一个placeholder的指针。从使用的角度看，any在实例化时，可以用任何类型 的数据来初始化，除了用any以外，其它的数据类型时，都会调用那个模板构造函数，它将生成一个holder对象，把初始数据存放在该对象中，同时把该 holder对象的指针存放在成员变量content中。由此可知，holder类肯定是从placeholder类继承而来的，之后的代码中就可以见证 到这一点。Boost根据编译器是否支持成员模板友员，特地小心地处理了any_cast和unsafe_any_cast两个辅助函数。
<pre><tt><tt>      <b><span style="color: rgb(0, 0, 255);">class</span></b> placeholder<br />     <span style="color: rgb(255, 0, 0);">{</span><br />     <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> structors</span></i><br /><br />         <b><span style="color: rgb(0, 0, 255);">virtual</span></b> <span style="color: rgb(153, 0, 0);">~</span><b><span style="color: rgb(0, 0, 0);">placeholder</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span><br />         <span style="color: rgb(255, 0, 0);">{</span><br />         <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> queries</span></i><br />         <b><span style="color: rgb(0, 0, 255);">virtual</span></b> <b><span style="color: rgb(0, 0, 255);">const</span></b> std<span style="color: rgb(153, 0, 0);">:</span><span style="color: rgb(153, 0, 0);">:</span>type_info <span style="color: rgb(153, 0, 0);">&</span> <b><span style="color: rgb(0, 0, 0);">type</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span> <b><span style="color: rgb(0, 0, 255);">const</span></b> <span style="color: rgb(153, 0, 0);">=</span> <span style="color: rgb(153, 51, 153);">0</span><span style="color: rgb(153, 0, 0);">;</span><br />         <b><span style="color: rgb(0, 0, 255);">virtual</span></b> placeholder <span style="color: rgb(153, 0, 0);">*</span> <b><span style="color: rgb(0, 0, 0);">clone</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span> <b><span style="color: rgb(0, 0, 255);">const</span></b> <span style="color: rgb(153, 0, 0);">=</span> <span style="color: rgb(153, 51, 153);">0</span><span style="color: rgb(153, 0, 0);">;</span><br />     <span style="color: rgb(255, 0, 0);">}</span><span style="color: rgb(153, 0, 0);">;</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">template</span></b><span style="color: rgb(153, 0, 0);"><</span><b><span style="color: rgb(0, 0, 255);">typename</span></b> ValueType<span style="color: rgb(153, 0, 0);">></span><br />     <b><span style="color: rgb(0, 0, 255);">class</span></b> holder <span style="color: rgb(153, 0, 0);">:</span> <b><span style="color: rgb(0, 0, 255);">public</span></b> placeholder<br />     <span style="color: rgb(255, 0, 0);">{</span><br />     <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> structors</span></i><br /><br />         <b><span style="color: rgb(0, 0, 0);">holder</span></b><span style="color: rgb(153, 0, 0);">(</span><b><span style="color: rgb(0, 0, 255);">const</span></b> ValueType <span style="color: rgb(153, 0, 0);">&</span> value<span style="color: rgb(153, 0, 0);">)</span><br />           <span style="color: rgb(153, 0, 0);">:</span> <b><span style="color: rgb(0, 0, 0);">held</span></b><span style="color: rgb(153, 0, 0);">(</span>value<span style="color: rgb(153, 0, 0);">)</span><br />         <span style="color: rgb(255, 0, 0);">{</span><br />         <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> queries</span></i><br /><br />         <b><span style="color: rgb(0, 0, 255);">virtual</span></b> <b><span style="color: rgb(0, 0, 255);">const</span></b> std<span style="color: rgb(153, 0, 0);">:</span><span style="color: rgb(153, 0, 0);">:</span>type_info <span style="color: rgb(153, 0, 0);">&</span> <b><span style="color: rgb(0, 0, 0);">type</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span> <b><span style="color: rgb(0, 0, 255);">const</span></b><br />         <span style="color: rgb(255, 0, 0);">{</span><br />             <b><span style="color: rgb(0, 0, 255);">return</span></b> <b><span style="color: rgb(0, 0, 255);">typeid</span></b><span style="color: rgb(153, 0, 0);">(</span>ValueType<span style="color: rgb(153, 0, 0);">)</span><span style="color: rgb(153, 0, 0);">;</span><br />         <span style="color: rgb(255, 0, 0);">}</span><br /><br />         <b><span style="color: rgb(0, 0, 255);">virtual</span></b> placeholder <span style="color: rgb(153, 0, 0);">*</span> <b><span style="color: rgb(0, 0, 0);">clone</span></b><span style="color: rgb(153, 0, 0);">(</span><span style="color: rgb(153, 0, 0);">)</span> <b><span style="color: rgb(0, 0, 255);">const</span></b><br />         <span style="color: rgb(255, 0, 0);">{</span><br />             <b><span style="color: rgb(0, 0, 255);">return</span></b> <b><span style="color: rgb(0, 0, 255);">new</span></b> <b><span style="color: rgb(0, 0, 0);">holder</span></b><span style="color: rgb(153, 0, 0);">(</span>held<span style="color: rgb(153, 0, 0);">)</span><span style="color: rgb(153, 0, 0);">;</span><br />         <span style="color: rgb(255, 0, 0);">}</span><br /><br />     <b><span style="color: rgb(0, 0, 255);">public</span></b><span style="color: rgb(153, 0, 0);">:</span> <i><span style="color: rgb(154, 25, 0);">//</span></i><i><span style="color: rgb(154, 25, 0);"> representation</span></i><br />         ValueType held<span style="color: rgb(153, 0, 0);">;</span><br />     <span style="color: rgb(255, 0, 0);">}</span><span style="color: rgb(153, 0, 0);">;</span></tt></tt></pre>
<p><span style="color: rgb(153, 0, 0);"></span>　　再看placeholder和holder类的实现，原来placeholder只是个接口声明，holder才是个模板类，可以根据不同的数据类型实例化，这样无论实例化后的类型是什么，在any中都可以用placeholder的指针来表示了。<br />　　Any的实现虽然很简单，但对于C++模板新手的我来说，还是很值得学习的！</p>
