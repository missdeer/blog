---
layout: post
image: https://img.peapix.com/1690293889243625540_320.jpg
author: missdeer
title: "又修正一个线程挂死的问题"
categories: Job
description: 又修正一个线程挂死的问题
tags: coding
---
最近一直在用shell脚本自动在跑一个简单的测试，就是不停地停止和重新启动一个relay进程，如此反复轮循，这样每过一段时间，比如两三天，或者更短或者更长，就会遇到一个问题：再也停不了任何一个relay进程，也不会重新启动进程。

说实话，我重现出这个问题很多次，但一直没有想到从哪里入手解决。这个问题涉及到三个部分：

- RESTful接口处理程序
- 消息分派程序
- 进程管理程序

从log看，前两个程序似乎一直在正常地收发消息。后来我发现重启前两个程序问题现象并不消失，只有重启进程管理程序才能恢复正常。

今天突然想到，这应该又是线程挂住在哪里引起的了。于是今天又重现了这个问题，立马用gdb attach上去，看了一下线程果然等在waitpid这个调用上了。程序原本的逻辑中就是收到一个stop子进程命令时，就发个SIGTERM信号过去，然后等它退出，Linux的进程创建和退出上，我一直觉得没有Windows那么容易理解。前段时间我为了修正杀子进程后变僵尸进程的问题，忽略了SIGCHLD信号，所以照理也不需要waitpid了，因为init进程会帮忙解决这个问题，但因为一时也没遇到问题，所以那行代码也一直留在那里。现在把这行代码删掉，问题应该就解决了。
